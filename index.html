<!DOCTYPE html>
<html>
  <head>
    <title>Nozzle Contour Generator</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
        display: flex;
        flex-direction: row;
        gap: 40px;
      }
      #controls {
        display: flex;
        flex-direction: column;
        width: 300px;
      }
      label {
        margin-top: 10px;
      }
      input {
        width: 100%;
      }
      #outputs {
        margin-top: 20px;
        font-size: 14px;
      }
      h1 {
        margin-bottom: 0;
      }
      h2 {
        margin-top: 40px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>Nozzle Contour Generator</h1>
      <p><em>By Saaketh Ramoju</em></p>

      <div id="controls">
        <label
          >Nozzle Shape:
          <select id="b_or_c" onchange="updatePlot()">
            <option value="Conical">Conical</option>
            <option value="Bell">Bell</option>
          </select>
        </label>

        <label
          >Throat Radius (in):
          <input
            id="R_t"
            type="range"
            min="1"
            max="3"
            step="0.01"
            value="1"
            oninput="updatePlot()"
          />
          <span id="R_t_val">1</span>
        </label>

        <label
          >Chamber Cylindrical Length (in):
          <input
            id="Lc"
            type="range"
            min="5"
            max="15"
            step="0.1"
            value="7.9"
            oninput="updatePlot()"
          />
          <span id="Lc_val">7.9</span>
        </label>

        <label
          >Contraction Ratio:
          <input
            id="eps_c"
            type="range"
            min="2"
            max="4.5"
            step="0.1"
            value="3.8"
            oninput="updatePlot()"
          />
          <span id="eps_c_val">3.8</span>
        </label>

        <label
          >Convergence Half-Angle (째):
          <input
            id="theta_c"
            type="range"
            min="25"
            max="40"
            step="0.1"
            value="37.5"
            oninput="updatePlot()"
          />
          <span id="theta_c_val">37.5</span>
        </label>

        <label
          >Convergence Radius Rc/Rt:
          <input
            id="Rc_Rt"
            type="range"
            min="0.5"
            max="1.5"
            step="0.1"
            value="1"
            oninput="updatePlot()"
          />
          <span id="Rc_Rt_val">1</span>
        </label>

        <label
          >Lead-in Radius Rtc/Rt:
          <input
            id="Rtc_Rt"
            type="range"
            min="0.5"
            max="1.5"
            step="0.1"
            value="1"
            oninput="updatePlot()"
          />
          <span id="Rtc_Rt_val">1</span>
        </label>

        <label
          >Lead-out Radius Rtd/Rt:
          <input
            id="Rtd_Rt"
            type="range"
            min="0.3"
            max="1.5"
            step="0.1"
            value="0.5"
            oninput="updatePlot()"
          />
          <span id="Rtd_Rt_val">0.5</span>
        </label>

        <label
          >Expansion Ratio:
          <input
            id="eps"
            type="range"
            min="2"
            max="100"
            step="0.1"
            value="4"
            oninput="updatePlot()"
          />
          <span id="eps_val">4</span>
        </label>

        <label
          >Divergence Half-Angle (째) [Conical]:
          <input
            id="alpha"
            type="range"
            min="10"
            max="25"
            step="1"
            value="15"
            oninput="updatePlot()"
          />
          <span id="alpha_val">15</span>
        </label>

        <label
          >Divergence Entrance Angle (째) [Bell]:
          <input
            id="theta_n"
            type="range"
            min="20"
            max="40"
            step="1"
            value="22"
            oninput="updatePlot()"
          />
          <span id="theta_n_val">22</span>
        </label>

        <label
          >Divergence Exit Angle (째) [Bell]:
          <input
            id="theta_e"
            type="range"
            min="5"
            max="20"
            step="1"
            value="10"
            oninput="updatePlot()"
          />
          <span id="theta_e_val">10</span>
        </label>

        <label
          >Percent Bell Lf (%):
          <input
            id="Lf"
            type="range"
            min="60"
            max="100"
            step="1"
            value="80"
            oninput="updatePlot()"
          />
          <span id="Lf_val">80</span>
        </label>

        <button onclick="downloadCSV()">Download Contour CSV</button>
      </div>
    </div>

    <div>
      <div id="plot" style="width: 800px; height: 600px"></div>
      <h2>Calculated Values</h2>
      <div id="outputs"></div>
    </div>

    <script>
      function getVal(id) {
        let el = document.getElementById(id);
        let val = parseFloat(el.value);
        document.getElementById(id + "_val").innerText = val;
        return val;
      }

      function linspace(start, stop, n) {
        return Array.from(
          { length: n },
          (_, i) => start + ((stop - start) * i) / (n - 1)
        );
      }

      function updatePlot() {
        let b_or_c = document.getElementById("b_or_c").value;
        let R_t = getVal("R_t");
        let Lc = getVal("Lc");
        let eps_c = getVal("eps_c");
        let theta_c = (getVal("theta_c") * Math.PI) / 180;
        let Rc = getVal("Rc_Rt") * R_t;
        let Rtc = getVal("Rtc_Rt") * R_t;
        let Rtd = getVal("Rtd_Rt") * R_t;
        let eps = getVal("eps");
        let alpha = (getVal("alpha") * Math.PI) / 180;
        let theta_n = (getVal("theta_n") * Math.PI) / 180;
        let theta_e = (getVal("theta_e") * Math.PI) / 180;
        let Lf = getVal("Lf");

        // --- Geometry sections (same as before) ---
        let f1z = linspace(0, Lc, 200);
        let f1r = f1z.map(() => Math.sqrt(eps_c) * R_t);
        let t2 = linspace(Math.PI / 2, Math.PI / 2 - theta_c, 200);
        let f2z = t2.map((tt) => Rc * Math.cos(tt) + Lc);
        let f2r = t2.map(
          (tt) => Rc * Math.sin(tt) + Math.sqrt(eps_c) * R_t - Rc
        );
        let y3 =
          R_t * (Math.sqrt(eps_c) - 1) -
          (Rc - Rc * Math.cos(theta_c)) -
          (Rtc - Rtc * Math.cos(theta_c));
        let x3 = y3 / Math.tan(theta_c);
        let f3z = linspace(f2z[f2z.length - 1], f2z[f2z.length - 1] + x3, 200);
        let m3 = -Math.tan(theta_c);
        let f3r = f3z.map(
          (z) => m3 * (z - f2z[f2z.length - 1]) + f2r[f2r.length - 1]
        );
        let h = f3z[f3z.length - 1] + Rtc * Math.sin(theta_c);
        let k = R_t + Rtc;
        let t4 = linspace(
          Math.PI + Math.PI / 2 - theta_c,
          (3 * Math.PI) / 2,
          200
        );
        let f4z = t4.map((tt) => Rtc * Math.cos(tt) + h);
        let f4r = t4.map((tt) => Rtc * Math.sin(tt) + k);

        let f5z, f5r;
        if (b_or_c == "Conical") {
          let t5 = linspace((3 * Math.PI) / 2, (3 * Math.PI) / 2 + alpha, 200);
          f5z = t5.map((tt) => Rtd * Math.cos(tt) + h);
          f5r = t5.map((tt) => Rtd * Math.sin(tt) + R_t + Rtd);
        } else {
          let t5 = linspace(
            (3 * Math.PI) / 2,
            (3 * Math.PI) / 2 + theta_n,
            200
          );
          f5z = t5.map((tt) => Rtd * Math.cos(tt) + h);
          f5r = t5.map((tt) => Rtd * Math.sin(tt) + R_t + Rtd);
        }

        let f6z, f6r;
        if (b_or_c == "Conical") {
          let length =
            (Math.sqrt(eps) * R_t - f5r[f5r.length - 1]) / Math.tan(alpha);
          f6z = linspace(
            f5z[f5z.length - 1],
            f5z[f5z.length - 1] + length,
            200
          );
          let m6 = Math.tan(alpha);
          f6r = f6z.map(
            (z) => m6 * (z - f5z[f5z.length - 1]) + f5r[f5r.length - 1]
          );
        } else {
          let N = [f5z[f5z.length - 1], f5r[f5r.length - 1]];
          let E = [
            (Lf / 100) *
              ((Math.sqrt(eps) * R_t - f5r[f5r.length - 1]) /
                Math.tan((15 * Math.PI) / 180)) +
              f4z[f4z.length - 1],
            Math.sqrt(eps) * R_t,
          ];
          let m1 = Math.tan(theta_n),
            m2 = Math.tan(theta_e);
          let Qx = (m1 * N[0] - N[1] - m2 * E[0] + E[1]) / (m1 - m2);
          let Qy = m1 * (Qx - N[0]) + N[1];
          let t = linspace(0, 1, 200);
          f6z = t.map(
            (tt) =>
              (1 - tt) ** 2 * N[0] + 2 * (1 - tt) * tt * Qx + tt ** 2 * E[0]
          );
          f6r = t.map(
            (tt) =>
              (1 - tt) ** 2 * N[1] + 2 * (1 - tt) * tt * Qy + tt ** 2 * E[1]
          );
        }

        let z = [].concat(
          f1z,
          f2z.slice(1),
          f3z.slice(1),
          f4z.slice(1),
          f5z.slice(1),
          f6z.slice(1)
        );
        let r = [].concat(
          f1r,
          f2r.slice(1),
          f3r.slice(1),
          f4r.slice(1),
          f5r.slice(1),
          f6r.slice(1)
        );
        window.currentContour = { z, r };

        Plotly.newPlot(
          "plot",
          [
            {
              x: f1z,
              y: f1r,
              mode: "lines",
              line: { width: 3, color: "#26a9e0" }, // light blue
              name: "Chamber",
            },
            {
              x: f2z,
              y: f2r,
              mode: "lines",
              line: { width: 3, color: "#e61950" }, // red
              name: "Entrance Arc",
            },
            {
              x: f3z,
              y: f3r,
              mode: "lines",
              line: { width: 3, color: "#f7a829" }, // orange
              name: "Converging Linear",
            },
            {
              x: f4z,
              y: f4r,
              mode: "lines",
              line: { width: 3, color: "#fa791b" }, // darker orange
              name: "Throat Arc",
            },
            {
              x: f5z,
              y: f5r,
              mode: "lines",
              line: { width: 3, color: "#510c7c" }, // purple
              name: "Diverging Entrance",
            },
            {
              x: f6z,
              y: f6r,
              mode: "lines",
              line: { width: 3, color: "#092843" }, // navy blue
              name: "Nozzle",
            },
          ],
          {
            xaxis: { title: "Axial Length (in)" },
            yaxis: { title: "Radial Length (in)" },
            showlegend: true,
          }
        );

        // --- Calculations ---
        let At = Math.PI * R_t ** 2;
        let Ainj = Math.PI * f1r[0] ** 2;
        let Aexit = Math.PI * f6r[f6r.length - 1] ** 2;
        let Lconv = f4z[f4z.length - 1] - f2z[0];
        let Lnoz = f6z[f6z.length - 1] - f4z[f4z.length - 1];
        let vol = 0,
          surf = 0;
        for (let i = 0; i < f1z.length - 1; i++) {
          let dx = f1z[i + 1] - f1z[i];
          vol += ((Math.PI * (f1r[i] ** 2 + f1r[i + 1] ** 2)) / 2) * dx;
        }
        let Lstar = vol / At;

        document.getElementById("outputs").innerHTML = `
          Throat Area: ${At.toFixed(3)} in짼<br>
          Injector Area: ${Ainj.toFixed(3)} in짼<br>
          Exit Area: ${Aexit.toFixed(3)} in짼<br>
          Converging Length: ${Lconv.toFixed(3)} in<br>
          Nozzle Length: ${Lnoz.toFixed(3)} in<br>
          Chamber Volume: ${vol.toFixed(3)} in쨀<br>
          Characteristic Length (L*): ${Lstar.toFixed(3)} in
        `;
      }

      function downloadCSV() {
        if (!window.currentContour) return;
        let { z, r } = window.currentContour;
        let rows = ["Z,R"];
        for (let i = 0; i < z.length; i++) rows.push(`${z[i]},${r[i]}`);
        let blob = new Blob([rows.join("\n")], { type: "text/csv" });
        let url = URL.createObjectURL(blob);
        let a = document.createElement("a");
        a.href = url;
        a.download = "contour.csv";
        a.click();
      }

      updatePlot();
    </script>
  </body>
</html>
